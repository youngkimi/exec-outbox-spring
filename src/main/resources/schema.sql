-- === DAG 버전 메타 (최신 버전 선택 용도) ===
CREATE TABLE IF NOT EXISTS TB_BAT_DAG_VERSION (
                                                  VERSION BIGINT PRIMARY KEY,
                                                  EFFECTIVE_AT TIMESTAMPTZ NOT NULL,
                                                  FROZEN_AT TIMESTAMPTZ
);

-- === 노드 정의 ===
CREATE TABLE IF NOT EXISTS TB_BAT_TASK_DEF (
                                               VERSION   BIGINT NOT NULL,
                                               TASK_KEY  VARCHAR(200) NOT NULL,
    HANDLER   VARCHAR(200) NOT NULL,
    TIMEOUT_S INTEGER NOT NULL DEFAULT 900,
    RETRIES   INTEGER NOT NULL DEFAULT 3,
    UNIQUE (VERSION, TASK_KEY)
    );

-- === 엣지(DAG) ===
CREATE TABLE IF NOT EXISTS TB_BAT_TASK_DEPENDENCY (
                                                      VERSION  BIGINT NOT NULL,
                                                      FROM_KEY VARCHAR(200) NOT NULL,
    TO_KEY   VARCHAR(200) NOT NULL,
    CONSTRAINT PK_TB_BAT_TASK_DEPENDENCY PRIMARY KEY (VERSION, FROM_KEY, TO_KEY)
    );
CREATE INDEX IF NOT EXISTS IX_DEP_TO   ON TB_BAT_TASK_DEPENDENCY (VERSION, TO_KEY);
CREATE INDEX IF NOT EXISTS IX_DEP_FROM ON TB_BAT_TASK_DEPENDENCY (VERSION, FROM_KEY);

-- === 러닝(run) 단위 ===
CREATE TABLE IF NOT EXISTS TB_BAT_DAG_RUN (
                                              RUN_ID      BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                              DAG_VERSION BIGINT       NOT NULL,
                                              BIZ_KEY     VARCHAR(200) NOT NULL,
    STATUS      VARCHAR(16)  NOT NULL DEFAULT 'PENDING',
    CREATED_AT  TIMESTAMPTZ  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT  TIMESTAMPTZ  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (DAG_VERSION, BIZ_KEY)
    );

-- === 노드 인스턴스 ===
CREATE TABLE IF NOT EXISTS TB_BAT_INSTANCE (
                                               ID          BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                               RUN_ID      BIGINT       NOT NULL,
                                               DAG_VERSION BIGINT       NOT NULL,
                                               BIZ_KEY     VARCHAR(200) NOT NULL,
    TASK_KEY    VARCHAR(200) NOT NULL,
    STATUS      VARCHAR(16)  NOT NULL DEFAULT 'PENDING',
    PRE_CNT     INTEGER      NOT NULL CHECK (PRE_CNT >= 0),
    ENQUEUED_AT TIMESTAMPTZ,
    CREATED_AT  TIMESTAMPTZ  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT  TIMESTAMPTZ  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (RUN_ID, TASK_KEY)
    );
CREATE INDEX IF NOT EXISTS IX_INST_READY ON TB_BAT_INSTANCE (RUN_ID, STATUS, PRE_CNT);

-- === Outbox/작업 큐 ===
CREATE TABLE IF NOT EXISTS TB_BAT_OUTBOX_EVENT (
                                                   ID           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                                   RUN_ID       BIGINT       NOT NULL,
                                                   INSTANCE_ID  BIGINT       NOT NULL,
                                                   TASK_KEY     VARCHAR(200) NOT NULL,
    STATUS       VARCHAR(16)  NOT NULL DEFAULT 'READY',
    WORKER_ID    VARCHAR(128),
    VISIBLE_AT   TIMESTAMPTZ  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ATTEMPTS     INTEGER      NOT NULL DEFAULT 0,
    FAIL_REASON  VARCHAR(4000),
    FAIL_STACK   TEXT,
    IS_DLQ       BOOLEAN      NOT NULL DEFAULT FALSE,
    PAYLOAD      JSONB        NOT NULL,
    STAGED_AT    TIMESTAMPTZ,
    LOGGED_AT    TIMESTAMPTZ,
    CREATED_AT   TIMESTAMPTZ  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT   TIMESTAMPTZ  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT CK_TB_BAT_OUTBOX_STATUS
    CHECK (STATUS IN ('READY','PROCESSING','STAGED','LOGGED','FAILED'))
    );

-- 활성 큐 단일성(READY/PROCESSING 기간 중 중복 큐잉 방지)
CREATE UNIQUE INDEX IF NOT EXISTS UQ_Q_ACTIVE_ONE
    ON TB_BAT_OUTBOX_EVENT (INSTANCE_ID)
    WHERE STATUS IN ('READY','PROCESSING') AND IS_DLQ=FALSE;

-- 폴링 인덱스
CREATE INDEX IF NOT EXISTS IX_Q_READY
    ON TB_BAT_OUTBOX_EVENT (STATUS, VISIBLE_AT)
    WHERE STATUS='READY' AND IS_DLQ=FALSE;
CREATE INDEX IF NOT EXISTS IX_Q_WORKER
    ON TB_BAT_OUTBOX_EVENT (WORKER_ID)
    WHERE STATUS='PROCESSING';
CREATE INDEX IF NOT EXISTS IX_Q_INSTANCE ON TB_BAT_OUTBOX_EVENT (INSTANCE_ID);
