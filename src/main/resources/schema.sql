-- =========================================================
-- 1) DAG(의존관계)
-- =========================================================
CREATE TABLE IF NOT EXISTS TB_BAT_TASK_DEPENDENCY (
    VERSION   BIGINT       NOT NULL,
    FROM_KEY  VARCHAR(200) NOT NULL,
    TO_KEY    VARCHAR(200) NOT NULL,
    CONSTRAINT PK_TB_BAT_TASK_DEPENDENCY PRIMARY KEY (VERSION, FROM_KEY, TO_KEY)
);

CREATE TABLE IF NOT EXISTS TB_BAT_INSTANCE (
    ID                   BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    DAG_VERSION          INTEGER        NOT NULL,
    BIZ_KEY              VARCHAR(200)   NOT NULL, -- DAILY >> PNT_2025-01-01
    STATUS               VARCHAR(16)    NOT NULL DEFAULT 'RUNNING',
    PRE_CNT              INTEGER        NOT NULL, -- 남은 선행 수(0 ⇒ 실행 가능)
    CREATED_AT           TIMESTAMPTZ    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT           TIMESTAMPTZ    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT CK_TB_BAT_INSTANCE_STATUS
    CHECK (STATUS IN ('RUNNING','COMPLETED','FAILED','ABORTED')),
);

-- =========================================================
-- 3) Outbox / Task 큐
--    - STAGED/LOGGED 2단계
-- =========================================================
CREATE TABLE IF NOT EXISTS TB_BAT_OUTBOX_EVENT (
    ID           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    INSTANCE_ID  BIGINT       NOT NULL,
    TASK_KEY     VARCHAR(200) NOT NULL,
    STATUS       VARCHAR(16)  NOT NULL DEFAULT 'READY',
    WORKER_ID    VARCHAR(128),
    VISIBLE_AT   TIMESTAMPTZ  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ATTEMPTS     INTEGER      NOT NULL DEFAULT 0,
    FAIL_REASON  VARCHAR(4000),
    FAIL_STACK   TEXT,
    IS_DLQ       BOOLEAN NOT NULL,
    PAYLOAD      JSONB        NOT NULL,          -- Oracle CLOB + JSON check → JSONB로 치환
    STAGED_AT    TIMESTAMPTZ,
    LOGGED_AT    TIMESTAMPTZ,
    CREATED_AT   TIMESTAMPTZ  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT   TIMESTAMPTZ  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT CK_TB_BAT_OUTBOX_STATUS
    CHECK (STATUS IN ('READY','PROCESSING','STAGED','LOGGED','FAILED'))
);
